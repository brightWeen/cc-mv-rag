# Milvus vs. ES+Milvus 混合检索对比报告 (更新版)

## 1. 对比背景 (Background)
本报告对比了在 RAG 场景下，**Milvus 单库方案**（Dense+Sparse）与 **ES+Milvus 双库方案**（ES BM25 + Milvus Dense）的性能。

*   **核心发现**：通过引入 **加权融合 (Weighted Fusion)**，Milvus 单库方案的性能大幅超越了 RRF 融合，缩小了与 ES 双库方案的差距。

## 2. 评测集设计 (Evaluation Set Design)

为了全面验证不同检索方案在多样化业务需求下的表现，本次评测设计了涵盖多维度的测试数据集。

### 数据规模与分布
*   **文档库**: 包含 10 篇核心技术文档（AI/ML/NLP 基础）和约 12 篇详细产品文档（手机、显卡、计算卡等硬件参数）。
*   **查询集**: 总计 30+ 条精心设计的测试查询（Queries），覆盖以下四大核心维度：

| 场景分类 (Scenario) | 示例 (Example) | 验证重点 |
| :--- | :--- | :--- |
| **语义理解 (Semantic)** | "什么是人工智能？", "适合 AI 训练的 GPU" | 考察 Dense 向量的语义泛化与概念对齐能力。 |
| **关键词匹配 (Keyword)** | "PyTorch TensorFlow", "BERT GPT" | 考察 Sparse 向量/BM25 对特定专有名词的精确捕捉能力。 |
| **混合查询 (Hybrid)** | "英伟达 AI 芯片 H100" | 考察混合检索在结合语义实体（AI 芯片）与精确型号（H100）时的融合效果。 |
| **边界测试 (Edge Cases)** | `RTX*` (通配符), `intell` (拼写错误) | 考察系统对非标准化输入的容错能力（主要用于对比 ES 优势）。 |

### 评测基准说明
每个查询都预先关联了 1-3 个**地面真值文档 (Relevant Docs)**。系统性能通过计算召回结果与真值的重合度及其排序位置来量化衡量。

## 3. 对比结果 (Results)

基于最新的评估数据，不同融合策略的表现如下：

| 方案 | 方法 | NDCG@10 | MRR | Recall@10 | 说明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **ES + Milvus** | **es_mv_hybrid_rrf** | **0.9398** 🥇 | **0.9310** 🥇 | **1.0000** 🥇 | **性能天花板** |
| **Only Milvus** | **hybrid_weighted** | **0.9198** 🥈 | **0.9019** 🥈 | **1.0000** 🥇 | **加权融合 (Dense 0.6)** |
| Only Milvus | dense | 0.8948 | 0.8747 | 0.9919 | 纯语义检索 |
| Only Milvus | hybrid_rrf | 0.8820 | 0.8602 | 0.9677 | RRF 融合 (效果下降) |

## 4. 深度分析：为什么加权融合更好？

### RRF 的局限性 (The RRF Flaw)
RRF 算法（`1/(k+rank)`）**只看排名，不看分数质量**。
*   **问题**：当 Sparse 召回的文档质量远低于 Dense 时，RRF 仍会赋予其较高的排名权重。例如：Sparse 第 1 名的得分可能远不如 Dense 第 5 名的相关性，但在 RRF 逻辑下，Sparse 第 1 名会占据极高的综合分。
*   **后果**：低质量文档“稀释”了高质量结果，导致 MRR 和 NDCG 下降。

### 加权融合的优势 (The Weighted Advantage)
加权算法（`w1*norm_score1 + w2*norm_score2`）**兼顾排名与质量分数**。
*   **优化**：通过给 Dense 赋予更高权重（如 0.6），系统确保了检索结果以语义理解为主。
*   **补充**：Sparse 作为“补丁”，仅在精确关键词匹配度极高时才贡献分数。
*   **结论**：在 Milvus 单库中，加权融合解决了两路召回“等权不对等”的问题，实现了 1+1 > 2 的效果。

## 5. 最终实施建议 (Recommendations)

| 需求优先级 | 推荐方案 | 预估效果 (NDCG) | 架构复杂度 |
| :--- | :--- | :--- | :--- |
| **最高性能** | **ES + Milvus (RRF)** | **~0.94** | **高** (需维护两个集群) |
| **极致性价比** | **Only Milvus (加权融合)** | **~0.92** | **低** (单一系统，运维简单) |
| **快速上线** | **Only Milvus (Dense)** | **~0.89** | **极低** |

### 总结
1.  **首选建议**：如果希望架构简单且性能优秀，推荐使用 **Milvus 单库 + 加权融合 (Dense=0.6, Sparse=0.4)**。这已足够覆盖绝大多数 RAG 业务场景。
2.  **极端场景**：只有在对精确匹配有近乎苛刻的要求（如处理大量混淆的 SKU 编号）时，才考虑引入 **ES + Milvus** 方案。
